<html>
<head>
	<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
	<script src="js/utils.js"></script>
	<script src="js/ui-utils.js"></script>
	<script src="js/json-parser.js"></script>
	<script type="text/javascript">
		"use strict";
		//SORTING FUNCTIONS
		//Inputs are arrays with the following format [<key>, <value>] (represents a JSON property)
		var sorts = ['none','lexographicKeySort', 'lexographicValueSort'];
		function lexographicKeySort(a,b) {
			if(a[0] > b[0]) return 1;
			else if(a[0] == b[0]) return 0;
			else return -1;
		}
		
		function lexographicValueSort(a,b) {
			if(a[1] > b[1]) return 1;
			else if(a[1] == b[1]) return 0;
			else return -1;
		}
		
		//FILTERING FUNCTIONS
		//Inputs are arrays with the following format [key, value] (represents a JSON property)
		var filters = ['none','removeFunctions'];
		function removeFunctions(arr) {
			return arr[1].substr(0,8).localeCompare('function') !== 0;
		}
		
		//GROUPBY FUNCTIONS
		//Inputs are arrays with the following format [<key>, <value>] (represents a JSON property)
		var groupBys = ['none', 'valType'];
		function valType(arr) {
			var t = typeof(arr[1]);
			switch(t) {
				case 'object':
					return arr[1] instanceof Array ? "array" : "object";
					break;
				default:
					return t;
			}
		}
		
		function work() {
			try {
				var text = $('#text').val();
				//Parse JSON
				var parsedVals = JSONParser.parse(text);
			
				var filterFunc = $('#filter').val();
				var sortFunc = $('#sort').val();
				var groupByFunc = $('#groupBy').val();
			
				if(Utils.strip(filterFunc) !== '') parsedVals = parsedVals.filter(Utils.createFunction(filterFunc));
				if(Utils.strip(sortFunc) !== '') parsedVals.sort(Utils.createFunction(sortFunc));
				if(Utils.strip(groupByFunc) !== '') {
					parsedVals = Utils.groupBy(parsedVals, Utils.createFunction(groupByFunc));
					json = [];
					for(var idx in parsedVals) {
						json.push([idx,JSONParser.generate(parsedVals[idx],2)]);
					}
					json = JSONParser.generate(json);
				} else {
					var json = JSONParser.generate(parsedVals);
				}
			
				//Convert to screen readable format
				$('#result').css('color', 'black').html(json.replace(/\n/g, '<br/>').replace(/\t/g, '&nbsp&nbsp&nbsp&nbsp'));
	    	} catch (e) {
				$('#result').css('color', 'red').html(e);
			}
		}
		
		function changeFilterFunc() {
			var flv = $('#filterList').val();
			var filterVal = flv == 'none' ? '' : window[flv].toString(); 
			$('#filter').val(filterVal);
		}
		
		function changeSortFunc() {
			var slv = $('#sortList').val();
			var sortVal = slv == 'none' ? '' : window[slv].toString(); 
			$('#sort').val(sortVal);
		}
		
		function changeGroupByFunc() {
			var glv = $('#groupByList').val();
			var groupByVal = glv == 'none' ? '' : window[glv].toString(); 
			$('#groupBy').val(groupByVal);
		}
		
		$(function() {
			$(document).delegate('textarea', 'keydown', UIUtils.insertTabOnTabPress);
			
			var sortList = $('#sortList'); 
			for(var idx in sorts) {
			    $('<option />', {value: sorts[idx], text: sorts[idx]}).appendTo(sortList);
			}
			var filterList = $('#filterList'); 
			for(var idx in filters) {
			    $('<option />', {value: filters[idx], text: filters[idx]}).appendTo(filterList);
			}
			var groupByList = $('#groupByList'); 
			for(var idx in groupBys) {
			    $('<option />', {value: groupBys[idx], text: groupBys[idx]}).appendTo(groupByList);
			}
		});
	</script>
</head>
<body>
	<div style="float:left;">
	<h1>JSON Transformer</h1>
	<input id="submitBtn" value="run" type="button" onclick='javascript:work()'>
	<h2>JSON</h2>
   	<textarea id="text" name="text" cols="75" rows="10" placeholder="Put JSON to transform here..."></textarea>
	<br/>
	<h2>Filter function</h2>
	<div>Examples: <select id="filterList" onchange="changeFilterFunc()"></select></div>
	<textarea id="filter" name="filter" cols="75" rows="10" placeholder="Put a filter function here..."></textarea>
	<br/>
	<h2>Sort function</h2>
	<div>Examples: <select id="sortList" onchange="changeSortFunc()"></select></div>
	<textarea id="sort" name="sort" cols="75" rows="10" placeholder="Put a sort function here..."></textarea>
	<br/>
	<h2>GroupBy function</h2>
	<div>Examples: <select id="groupByList" onchange="changeGroupByFunc()"></select></div>
	<textarea id="groupBy" name="groupBy" cols="75" rows="10" placeholder="Put a groupBy function here..."></textarea>
	<br/>
	</div>
	<div style="float:left;margin-left:40px">
	<h1>Results</h1>
	<div id="result"></div>
	</div>
</body>
</html>